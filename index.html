<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Nasabah KSP Setya Karya - Scan Mode Aktif</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        /* CSS Anda yang sudah ada */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 10px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .tabs {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            gap: 5px;
        }
        
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            background: #f1f1f1;
            border-radius: 5px 5px 0 0;
            transition: all 0.3s ease;
            margin-bottom: 5px;
            font-size: 0.9rem;
            flex-grow: 1;
            text-align: center;
        }
        
        .tab.active {
            background: #2a5298;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
            gap: 10px;
        }
        
        .search-box {
            padding: 12px 15px;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 50px;
            font-size: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 2px 12px rgba(42, 82, 152, 0.3);
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2a5298, #1e3c72);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            box-shadow: 0 4px 12px rgba(42, 82, 152, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #218838);
            color: white;
        }
        
        .btn-success:hover {
            background: linear-gradient(135deg, #218838, #28a745);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #c82333, #dc3545);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: white;
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #e0a800, #ffc107);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
        }
        
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.12);
        }
        
        .card-header {
            background: linear-gradient(135deg, #2a5298, #1e3c72);
            color: white;
            padding: 12px 15px;
            text-align: center;
        }
        
        .card-body {
            padding: 15px;
        }
        
        .customer-id {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 1rem;
        }
        
        .customer-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: #2c3e50;
        }
        
        .customer-detail {
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        
        .detail-label {
            font-weight: 600;
            color: #7f8c8d;
        }
        
        .qr-code {
            text-align: center;
            margin: 15px 0;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        
        .actions {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        /* Form Styles */
        .form-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
        }
        
        .form-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #2c3e50;
            text-align: center;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95rem;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 2px 8px rgba(42, 82, 152, 0.3);
        }
        
        .form-actions {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* Table view */
        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        
        th, td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 0.9rem;
        }
        
        th {
            background-color: #2a5298;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .action-cell {
            display: flex;
            gap: 5px;
        }
        
        /* Login form */
        .login-container {
            max-width: 400px;
            margin: 30px auto;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        }
        
        /* Settings form */
        .settings-container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        }
        
        /* Import section */
        .import-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
        }
        
        .drop-zone {
            border: 2px dashed #2a5298;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .drop-zone:hover {
            background-color: #f0f8ff;
        }
        
        .drop-zone p {
            margin-bottom: 12px;
            color: #7f8c8d;
        }
        
        /* Password protection modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh; /* Batasan tinggi untuk scroll */
            overflow-y: auto; /* Aktifkan scroll jika kontennya panjang */
        }
        
        .modal-title {
            text-align: center;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .no-results {
            text-align: center;
            padding: 30px;
            font-size: 1.1rem;
            color: #7f8c8d;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 15px;
            color: #7f8c8d;
            font-size: 0.85rem;
        }
        
        /* Preview image style */
        .preview-image {
            max-width: 100%;
            max-height: 150px;
            border-radius: 8px;
            margin-top: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* Mobile-specific styles */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            header {
                padding: 12px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .tab {
                padding: 8px 10px;
                font-size: 0.8rem;
            }
            
            .card-container {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            
            .actions {
                flex-direction: column;
                align-items: center;
            }
            
            .actions .btn {
                width: 100%;
                max-width: 200px;
            }
            
            .form-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .form-actions .btn {
                width: 100%;
                max-width: 250px;
            }
        }

        /* Status indicator */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-online {
            background-color: #28a745;
        }
        
        .status-offline {
            background-color: #dc3545;
        }
        
        .connection-status {
            text-align: center;
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .connection-online {
            background-color: #d4edda;
            color: #155724;
        }
        
        .connection-offline {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>DATABASE NASABAH KSP SETYA KARYA</h1>
            <p class="subtitle">Sistem Manajemen Data Nasabah dengan QR Code (Scan Mode Aktif)</p>
        </header>
        
        <div id="loginSection" style="display: none;">
            <div class="login-container">
                <h2 class="login-title">Login Admin</h2>
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="username" placeholder="Masukkan username">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="password" placeholder="Masukkan password">
                </div>
                <div class="form-actions">
                    <button class="btn btn-primary" onclick="login()">Login</button>
                </div>
                <p style="text-align: center; margin-top: 20px; color: #7f8c8d;">
                    Username: <strong>admin</strong> | Password: <strong>admin123</strong> (Segera ganti di Pengaturan)
                </p>
            </div>
        </div>
        
        <div id="mainSection" style="display: none;">
            <div id="connectionStatus" class="connection-status connection-offline">
                Mode offline - Data disimpan secara lokal
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="showTab('view')">Lihat Data</div>
                <div class="tab" onclick="showTab('add')">Tambah Nasabah</div>
                <div class="tab" onclick="showTab('import')">Import Data</div>
                <div class="tab" onclick="showTab('table')">Tampilan Tabel</div>
                <div class="tab" onclick="showTab('settings')">Pengaturan</div>
                <div class="tab" onclick="logout()">Logout</div>
            </div>
            
            <div id="viewTab" class="tab-content active">
                <div class="controls">
                    <input type="text" id="searchInput" class="search-box" placeholder="Cari nasabah berdasarkan nama, NIK, atau alamat...">
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="exportToCSV()">
                            üì• Export CSV
                        </button>
                        <button class="btn btn-primary" onclick="saveData(true)">
                            üíæ Simpan Lokal
                        </button>
                        <button class="btn btn-warning" onclick="syncData()">
                            üîÑ Sinkronisasi Server
                        </button>
                    </div>
                </div>
                
                <div class="card-container" id="customerCards">
                    </div>
            </div>
            
            <div id="addTab" class="tab-content">
                <div class="form-section">
                    <h2 class="form-title" id="formTitle">Tambah Data Nasabah Baru</h2>
                    <form id="customerForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">No</label>
                                <input type="number" class="form-input" id="no" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Customer ID</label>
                                <input type="text" class="form-input" id="customerId" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tanggal Drop</label>
                                <input type="date" class="form-input" id="tglDrop" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">NIK</label>
                                <input type="text" class="form-input" id="nik" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nama</label>
                                <input type="text" class="form-input" id="nama" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Alamat</label>
                                <textarea class="form-input" id="alamat" rows="2" required></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Dokumen</label>
                                <textarea class="form-input" id="dokumen" rows="2" required></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Pinjaman (Rp)</label>
                                <input type="text" class="form-input" id="pinjamankin" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Pinjamanki</label>
                                <input type="text" class="form-input" id="pinjamanki" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Foto Nasabah (URL)</label>
                                <input type="text" class="form-input" id="fotoNasabah" placeholder="Paste link foto (Google Drive/Dropbox publik)">
                                <small style="color: #dc3545; font-weight: 600;">
                                    ‚ö†Ô∏è **Wajib link publik (Siapa pun dengan link)** agar foto muncul saat di-scan.
                                </small>
                                <div id="previewFotoNasabah" style="margin-top: 10px;"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Foto Rumah Nasabah (URL)</label>
                                <input type="text" class="form-input" id="fotoRumah" placeholder="Paste link foto (Google Drive/Dropbox publik)">
                                <small style="color: #dc3545; font-weight: 600;">
                                    ‚ö†Ô∏è **Wajib link publik (Siapa pun dengan link)** agar foto muncul saat di-scan.
                                </small>
                                <div id="previewFotoRumah" style="margin-top: 10px;"></div>
                            </div>
                            </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-success" id="submitButton">Simpan Data Nasabah</button>
                            <button type="button" class="btn btn-danger" onclick="resetForm()">Reset/Batal Edit</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div id="importTab" class="tab-content">
                <div class="import-section">
                    <h2 class="form-title">Import Data dari Excel/CSV</h2>
                    <div class="drop-zone" id="dropZone">
                        <p>Seret file Excel atau CSV ke sini atau klik untuk memilih file</p>
                        <button class="btn btn-primary">Pilih File</button>
                        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-success" onclick="document.getElementById('fileInput').click()">
                            Pilih File dari Komputer
                        </button>
                    </div>
                    <div id="importPreview" style="margin-top: 30px;"></div>
                </div>
            </div>
            
            <div id="tableTab" class="tab-content">
                <div class="controls">
                    <input type="text" id="tableSearchInput" class="search-box" placeholder="Cari nasabah...">
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="exportToCSV()">
                            üì• Export CSV
                        </button>
                        <button class="btn btn-primary" onclick="saveData(true)">
                            üíæ Simpan Data
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="customersTable">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Customer ID</th>
                                <th>Nama</th>
                                <th>NIK</th>
                                <th>Alamat</th>
                                <th>Pinjaman</th>
                                <th>Foto Nasabah</th>
                                <th>Foto Rumah</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
            
            <div id="settingsTab" class="tab-content">
                <div class="settings-container">
                    <h2 class="form-title">Pengaturan Sistem</h2>
                    <div class="form-group">
                        <label class="form-label">Username Admin</label>
                        <input type="text" class="form-input" id="adminUsername" value="admin">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password Admin Baru</label>
                        <input type="password" class="form-input" id="adminNewPassword" placeholder="Masukkan password baru">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Konfirmasi Password Baru</label>
                        <input type="password" class="form-input" id="adminConfirmPassword" placeholder="Konfirmasi password baru">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password QR Code (Untuk Semua Nasabah)</label>
                        <input type="password" class="form-input" id="globalQrPassword" placeholder="Password untuk membuka QR code">
                        <small style="color: #7f8c8d;">Password ini digunakan untuk semua QR code. Hanya Anda yang bisa mengubahnya.</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Konfirmasi Password QR Code</label>
                        <input type="password" class="form-input" id="globalQrConfirmPassword" placeholder="Konfirmasi password QR code">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Firebase Configuration (JSON)</label>
                        <textarea class="form-input" id="firebaseConfig" rows="6" placeholder='{"apiKey":"...","databaseURL":"..."}'></textarea>
                        <small style="color: #7f8c8d;">Dapatkan konfigurasi dari Firebase Console. Kosongkan jika tidak ingin menggunakan sinkronisasi.</small>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-success" onclick="saveSettings()">Simpan Pengaturan</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Masukkan Password QR Code</h2>
            <div class="form-group">
                <label class="form-label">Password</label>
                <input type="password" class="form-input" id="qrPasswordInput" placeholder="Masukkan password untuk melihat data">
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="checkQrPassword()">Buka Data</button>
                <button class="btn btn-danger" onclick="closeModal()">Batal</button>
            </div>
            <p style="text-align: center; margin-top: 15px; color: #7f8c8d;">
                Dapatkan password dari admin KSP Setya Karya
            </p>
        </div>
    </div>
    
    <footer>
        <p>¬© 2025 KSP Setya Karya Tanggulangin - Sistem Manajemen Nasabah</p>
    </footer>

    <script>
        // Data nasabah
        let customers = [];
        let currentEditId = null;
        let qrPasswordData = null;
        let db = null;
        let isOnline = false;
        
        // Pengaturan sistem (default)
        let systemSettings = {
            adminUsername: "admin",
            adminPassword: "admin123", 
            globalQrPassword: "ksp2025", 
            firebaseConfig: null
        };

        // --- FUNGSI UTILITY ---
        function generateUniqueId() {
             return Date.now() + Math.random().toString(36).substr(2, 9);
        }

        function resetForm() {
            document.getElementById('customerForm').reset();
            document.getElementById('formTitle').textContent = 'Tambah Data Nasabah Baru';
            document.getElementById('submitButton').textContent = 'Simpan Data Nasabah';
            document.getElementById('previewFotoNasabah').innerHTML = '';
            document.getElementById('previewFotoRumah').innerHTML = '';
            currentEditId = null;
        }

        function getDirectGDriveUrl(url) {
            // Mengubah URL sharing Google Drive menjadi URL direct content (embed)
            try {
                if (url.includes("drive.google.com/file/d/")) {
                    const match = url.match(/d\/([a-zA-Z0-9_-]+)/);
                    if (match && match[1]) {
                        return `https://drive.google.com/uc?id=${match[1]}`;
                    }
                }
                return url; // Kembalikan URL asli jika format tidak dikenali
            } catch (e) {
                return url;
            }
        }
        
        function loginSuccess() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('mainSection').style.display = 'block';
            initFirebase();
            createCustomerCards(customers);
        }

        // --- END FUNGSI UTILITY ---


        // --- FIREBASE DAN LOCAL STORAGE ---
        
        function initFirebase() {
            try {
                if (systemSettings.firebaseConfig) {
                    if (firebase.apps.length > 0) {
                        firebase.app().delete();
                    }
                    
                    const config = typeof systemSettings.firebaseConfig === 'string' 
                        ? JSON.parse(systemSettings.firebaseConfig) 
                        : systemSettings.firebaseConfig;
                    
                    firebase.initializeApp(config);
                    db = firebase.database();
                    
                    db.ref('customers').on('value', (snapshot) => {
                        const remoteData = snapshot.val();
                        if (remoteData) {
                            customers = mergeCustomers(customers, remoteData);
                            createCustomerCards(customers);
                            renderTable();
                            saveData(false); 
                        }
                    });
                    
                    const connectedRef = firebase.database().ref(".info/connected");
                    connectedRef.on("value", function(snap) {
                        isOnline = snap.val() === true;
                        updateConnectionStatus();
                    });

                } else {
                    isOnline = false;
                    updateConnectionStatus();
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                isOnline = false;
                updateConnectionStatus();
            }
        }
        
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            if (isOnline) {
                statusElement.textContent = 'Terhubung - Data disinkronisasi dengan server';
                statusElement.className = 'connection-status connection-online';
            } else {
                statusElement.textContent = 'Mode offline - Data disimpan secara lokal';
                statusElement.className = 'connection-status connection-offline';
            }
        }
        
        function mergeCustomers(localData, remoteObject) {
            const remoteArray = remoteObject ? Object.values(remoteObject) : [];
            const mergedMap = new Map();

            localData.forEach(item => mergedMap.set(item.customerId, item));

            remoteArray.forEach(remoteItem => {
                const localItem = mergedMap.get(remoteItem.customerId);
                if (!localItem || (remoteItem.updatedAt || 0) >= (localItem.updatedAt || 0)) {
                    mergedMap.set(remoteItem.customerId, remoteItem);
                }
            });
            
            return Array.from(mergedMap.values());
        }
        
        function loadData() {
            const savedData = localStorage.getItem('kspSetyaKaryaData');
            if (savedData) {
                customers = JSON.parse(savedData);
            }
        }
        
        function loadSettings() {
            const savedSettings = localStorage.getItem('kspSetyaKaryaSettings');
            if (savedSettings) {
                const parsedSettings = JSON.parse(savedSettings);
                systemSettings = {...systemSettings, ...parsedSettings};
            }
            
            document.getElementById('adminUsername').value = systemSettings.adminUsername;
            document.getElementById('globalQrPassword').value = systemSettings.globalQrPassword;
            
            if (systemSettings.firebaseConfig) {
                document.getElementById('firebaseConfig').value = 
                    typeof systemSettings.firebaseConfig === 'string' 
                    ? systemSettings.firebaseConfig 
                    : JSON.stringify(systemSettings.firebaseConfig, null, 2);
            }
        }

        function saveData(show_alert = true) {
            localStorage.setItem('kspSetyaKaryaData', JSON.stringify(customers));
            if (show_alert) {
                 alert('Data berhasil disimpan secara lokal!');
            }
        }
        
        function syncData() {
            if (db && isOnline) {
                const customersObject = customers.reduce((obj, customer) => {
                    obj[customer.customerId] = customer;
                    return obj;
                }, {});

                db.ref('customers').set(customersObject)
                    .then(() => {
                        alert('Data berhasil disinkronisasi ke server!');
                    })
                    .catch((error) => {
                        alert('Error sinkronisasi data: ' + error.message);
                    });
            } else {
                alert('Firebase tidak terhubung atau belum dikonfigurasi. Silakan cek Pengaturan.');
            }
        }
        // --- END FIREBASE DAN LOCAL STORAGE ---


        // --- LOGIKA UTAMA APLIKASI ---

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === systemSettings.adminUsername && password === systemSettings.adminPassword) {
                localStorage.setItem('kspSetyaKaryaLoggedIn', 'true'); // Simpan status login
                loginSuccess();
            } else {
                alert('Username atau password salah!');
            }
        }
        
        function logout() {
            localStorage.removeItem('kspSetyaKaryaLoggedIn');
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('mainSection').style.display = 'none';
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            const tabMap = {
                'view': 1, 'add': 2, 'import': 3, 'table': 4, 'settings': 5
            };
            
            if (tabMap[tabName]) {
                document.querySelector(`.tab:nth-child(${tabMap[tabName]})`).classList.add('active');
                document.getElementById(`${tabName}Tab`).classList.add('active');
            }

            if (tabName === 'table') {
                 renderTable();
            }
            if (tabName === 'add') {
                 resetForm(); 
            }
        }
        
        function createCustomerCards(customersToShow) {
            const container = document.getElementById('customerCards');
            container.innerHTML = '';
            
            if (customersToShow.length === 0) {
                container.innerHTML = '<div class="no-results">Tidak ada data nasabah yang ditemukan.</div>';
                return;
            }
            
            customersToShow.forEach(customer => {
                const card = document.createElement('div');
                card.className = 'card';
                
                // Konten QR Code: URL aplikasi + CustomerID
                // Ganti 'index.html' dengan URL GitHub Pages Anda saat dipublikasikan
                const appUrl = window.location.origin + window.location.pathname; 
                const qrContent = `${appUrl}?customerId=${customer.customerId}`;

                const qr = qrcode(0, 'M');
                qr.addData(qrContent);
                qr.make();
                
                const qrSvg = qr.createSvgTag({scale: 4, margin: 0});
                
                card.innerHTML = `
                    <div class="card-header">
                        <div class="customer-id">${customer.customerId}</div>
                    </div>
                    <div class="card-body">
                        <div class="customer-name">${customer.nama}</div>
                        <div class="customer-detail"><span class="detail-label">NIK:</span> ${customer.nik}</div>
                        <div class="customer-detail"><span class="detail-label">Pinjaman:</span> Rp ${customer.pinjamankin}</div>
                        
                        <div class="qr-code">
                            ${qrSvg}
                            <small style="color: #7f8c8d;">Scan QR ini untuk akses cepat data.</small>
                        </div>
                        <div class="actions">
                            <button class="btn btn-primary" onclick="viewCustomer('${customer.customerId}')">Lihat Detail</button>
                            <button class="btn btn-warning" onclick="editCustomer('${customer.customerId}')">Edit</button>
                            <button class="btn btn-danger" onclick="deleteCustomer('${customer.customerId}')">Hapus</button>
                            <button class="btn btn-success" onclick="downloadQRCode('${customer.customerId}')">Download QR</button>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }
        
        // MODIFIKASI: Tombol Lihat Detail di mode Admin hanya mengarahkan ke URL Scan Mode
        function viewCustomer(customerId) {
            // Kita arahkan browser ke URL dengan parameter customerId, 
            // sehingga memicu alur verifikasi password QR
            window.location.href = `index.html?customerId=${customerId}`;
        }
        
        // MODIFIKASI: checkQrPassword kini menampilkan data dan foto di modal
        function checkQrPassword() {
            const password = document.getElementById('qrPasswordInput').value;
            
            if (password === systemSettings.globalQrPassword) {
                const customer = qrPasswordData;
                
                // Pastikan modal memiliki scroll jika kontennya panjang
                document.querySelector('.modal-content').style.maxWidth = '95%';
                document.querySelector('.modal-content').style.maxHeight = '90vh';

                let detailHtml = `
                    <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px; margin-top: 15px; background: #f9f9f9;">
                        <h3 style="color: #2a5298; border-bottom: 2px solid #ddd; padding-bottom: 5px;">Data Nasabah</h3>
                        <p><strong>Customer ID:</strong> ${customer.customerId}</p>
                        <p><strong>Nama:</strong> ${customer.nama}</p>
                        <p><strong>NIK:</strong> ${customer.nik}</p>
                        <p><strong>Alamat:</strong> ${customer.alamat}</p>
                        <p><strong>Pinjaman:</strong> Rp ${customer.pinjamankin}</p>
                        <p><strong>Pinjamanki:</strong> ${customer.pinjamanki}</p>
                        <p><strong>Dokumen:</strong> ${customer.dokumen}</p>
                    </div>
                    
                    ${customer.fotoNasabah ? 
                        `<div style="margin-top: 15px; text-align: center; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #fff;">
                            <h3 style="color: #2a5298;">Foto Nasabah</h3>
                            <img src="${getDirectGDriveUrl(customer.fotoNasabah)}" alt="Foto Nasabah" style="max-width: 100%; height: auto; border-radius: 8px; max-height: 250px;">
                        </div>` 
                        : ''}
                    
                    ${customer.fotoRumah ? 
                        `<div style="margin-top: 15px; text-align: center; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #fff;">
                            <h3 style="color: #2a5298;">Foto Rumah</h3>
                            <img src="${getDirectGDriveUrl(customer.fotoRumah)}" alt="Foto Rumah" style="max-width: 100%; height: auto; border-radius: 8px; max-height: 250px;">
                        </div>` 
                        : ''}
                `;

                document.querySelector('.modal-content').innerHTML = `
                    <h2 class="modal-title">Data Nasabah Terverifikasi</h2>
                    ${detailHtml}
                    <div class="form-actions" style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="window.location.href='index.html'">Tutup</button>
                    </div>
                `;
                
            } else {
                alert('Password salah! Akses ditolak.');
            }
        }
        
        function closeModal() {
            // Di mode Scan View, ini akan mengarahkan kembali ke index.html kosong
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('customerId')) {
                window.location.href = 'index.html'; 
            } else {
                document.getElementById('passwordModal').style.display = 'none';
                document.getElementById('qrPasswordInput').value = '';
                qrPasswordData = null;
            }
        }
        
        function editCustomer(customerId) {
            const customer = customers.find(c => c.customerId === customerId);
            if (customer) {
                currentEditId = customerId;
                
                document.getElementById('formTitle').textContent = 'Edit Data Nasabah';
                document.getElementById('submitButton').textContent = 'Update Data Nasabah';
                document.getElementById('no').value = customer.no;
                document.getElementById('customerId').value = customer.customerId;
                document.getElementById('tglDrop').value = customer.tglDrop;
                document.getElementById('nik').value = customer.nik;
                document.getElementById('nama').value = customer.nama;
                document.getElementById('alamat').value = customer.alamat;
                document.getElementById('dokumen').value = customer.dokumen;
                document.getElementById('pinjamankin').value = customer.pinjamankin;
                document.getElementById('pinjamanki').value = customer.pinjamanki;

                document.getElementById('fotoNasabah').value = customer.fotoNasabah || '';
                document.getElementById('fotoRumah').value = customer.fotoRumah || '';

                document.getElementById('previewFotoNasabah').innerHTML = customer.fotoNasabah ? 
                    `<img src="${getDirectGDriveUrl(customer.fotoNasabah)}" alt="Foto Nasabah" class="preview-image">` : '';
                document.getElementById('previewFotoRumah').innerHTML = customer.fotoRumah ? 
                    `<img src="${getDirectGDriveUrl(customer.fotoRumah)}" alt="Foto Rumah" class="preview-image">` : '';
                
                showTab('add');
            }
        }
        
        function deleteCustomer(customerId) {
            if (confirm('Apakah Anda yakin ingin menghapus nasabah ini?')) {
                customers = customers.filter(c => c.customerId !== customerId);
                createCustomerCards(customers);
                renderTable();
                saveData();
                
                if (db) {
                    db.ref('customers/' + customerId).remove();
                }
            }
        }
        
        function downloadQRCode(customerId) {
            const customer = customers.find(c => c.customerId === customerId);
            if (customer) {
                const appUrl = window.location.origin + window.location.pathname; 
                const qrContent = `${appUrl}?customerId=${customer.customerId}`;

                const qr = qrcode(0, 'M');
                qr.addData(qrContent);
                qr.make();
                
                const svgString = qr.createSvgTag({scale: 8, margin: 2});
                const blob = new Blob([svgString], {type: 'image/svg+xml'});
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `QR_${customer.nama.replace(/\s+/g, '_')}_${customerId}.svg`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }
        
        function renderTable() {
            const tableBody = document.querySelector('#customersTable tbody');
            tableBody.innerHTML = '';
            
            customers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.no}</td>
                    <td>${customer.customerId}</td>
                    <td>${customer.nama}</td>
                    <td>${customer.nik}</td>
                    <td>${customer.alamat}</td>
                    <td>Rp ${customer.pinjamankin}</td>
                    <td>${customer.fotoNasabah ? 'Ada (URL)' : 'Tidak Ada'}</td>
                    <td>${customer.fotoRumah ? 'Ada (URL)' : 'Tidak Ada'}</td>
                    <td class="action-cell">
                        <button class="btn btn-primary btn-sm" onclick="viewCustomer('${customer.customerId}')">Lihat</button>
                        <button class="btn btn-warning btn-sm" onclick="editCustomer('${customer.customerId}')">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteCustomer('${customer.customerId}')">Hapus</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        document.getElementById('customerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const isEditing = !!currentEditId; 

            const customerData = {
                id: generateUniqueId(), 
                no: parseInt(document.getElementById('no').value),
                customerId: document.getElementById('customerId').value,
                tglDrop: document.getElementById('tglDrop').value,
                nik: document.getElementById('nik').value,
                nama: document.getElementById('nama').value,
                alamat: document.getElementById('alamat').value,
                dokumen: document.getElementById('dokumen').value,
                pinjamankin: document.getElementById('pinjamankin').value,
                pinjamanki: document.getElementById('pinjamanki').value,
                
                fotoNasabah: document.getElementById('fotoNasabah').value.trim() || null,
                fotoRumah: document.getElementById('fotoRumah').value.trim() || null,
                updatedAt: Date.now()
            };

            if (isEditing) {
                const index = customers.findIndex(c => c.customerId === currentEditId);
                if (index !== -1) {
                    customerData.id = customers[index].id; 
                    customers[index] = customerData;
                }
            } else {
                if (customers.some(c => c.customerId === customerData.customerId)) {
                    alert('Customer ID sudah ada. Gunakan ID yang berbeda atau lakukan edit.');
                    return;
                }
                customers.push(customerData);
            }

            createCustomerCards(customers);
            renderTable();
            saveData();
            
            if (db) {
                db.ref('customers/' + customerData.customerId).set(customerData); 
            }
            
            resetForm();
            alert('Data nasabah berhasil disimpan/diperbarui!');
            showTab('view');
        });

        document.getElementById('fotoNasabah').addEventListener('input', function(e) {
            const url = getDirectGDriveUrl(e.target.value.trim());
            const previewDiv = document.getElementById('previewFotoNasabah');
            previewDiv.innerHTML = url ? `<img src="${url}" alt="Preview Foto Nasabah" class="preview-image">` : '';
        });
        
        document.getElementById('fotoRumah').addEventListener('input', function(e) {
            const url = getDirectGDriveUrl(e.target.value.trim());
            const previewDiv = document.getElementById('previewFotoRumah');
            previewDiv.innerHTML = url ? `<img src="${url}" alt="Preview Foto Rumah" class="preview-image">` : '';
        });
        
        
        function saveSettings() {
            const newUsername = document.getElementById('adminUsername').value;
            const newPassword = document.getElementById('adminNewPassword').value;
            const confirmPassword = document.getElementById('adminConfirmPassword').value;
            const newQrPassword = document.getElementById('globalQrPassword').value;
            const confirmQrPassword = document.getElementById('globalQrConfirmPassword').value;
            const firebaseConfig = document.getElementById('firebaseConfig').value;
            
            if (newPassword && newPassword !== confirmPassword) {
                alert('Password baru dan konfirmasi password tidak cocok!');
                return;
            }
            
            if (newQrPassword !== confirmQrPassword) {
                alert('Password QR Code dan konfirmasi password tidak cocok!');
                return;
            }
            
            systemSettings.adminUsername = newUsername;
            if (newPassword) {
                systemSettings.adminPassword = newPassword;
            }
            
            systemSettings.globalQrPassword = newQrPassword;
            
            try {
                if (firebaseConfig.trim()) {
                    systemSettings.firebaseConfig = JSON.parse(firebaseConfig);
                } else {
                    systemSettings.firebaseConfig = null;
                }
            } catch (e) {
                alert('Format Firebase Configuration tidak valid!');
                return;
            }
            
            localStorage.setItem('kspSetyaKaryaSettings', JSON.stringify(systemSettings));
            alert('Pengaturan berhasil disimpan! Aplikasi akan mencoba inisialisasi ulang Firebase.');
            
            initFirebase();
        }
        
        // --- LOGIKA UTAMA SCAN MODE ---
        
        function handleScanView(scannedId) {
            const customer = customers.find(c => c.customerId === scannedId);
            
            if (customer) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('mainSection').style.display = 'none';
                
                qrPasswordData = customer;
                document.getElementById('passwordModal').style.display = 'flex';
                
                document.querySelector('.modal-title').textContent = `Verifikasi Data Nasabah (${customer.customerId})`;
                
            } else {
                alert(`Data nasabah dengan ID ${scannedId} tidak ditemukan di database! Silakan login admin untuk sinkronisasi data terbaru.`);
                document.getElementById('loginSection').style.display = 'block';
            }
        }
        
        // Inisialisasi saat halaman dimuat
        window.onload = function() {
            loadSettings();
            loadData(); 
            
            const urlParams = new URLSearchParams(window.location.search);
            const scannedId = urlParams.get('customerId');

            if (scannedId) {
                // MODE PETUGAS LAPANGAN (SCAN VIEW)
                handleScanView(scannedId);
            } else {
                // MODE ADMIN (DEFAULT)
                if (localStorage.getItem('kspSetyaKaryaLoggedIn') === 'true') {
                     loginSuccess();
                } else {
                     document.getElementById('loginSection').style.display = 'block';
                }
            }
        };
        // --- END LOGIKA UTAMA SCAN MODE ---
        
        // --- LOGIKA IMPORT TETAP SAMA --- (Hanya menyalin bagian fungsional)
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        
        dropZone.addEventListener('click', () => { fileInput.click(); });
        fileInput.addEventListener('change', handleFileSelect);
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() { dropZone.style.backgroundColor = '#f0f8ff'; }
        function unhighlight() { dropZone.style.backgroundColor = ''; }
        
        dropZone.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }
        
        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }
        
        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                const fileExtension = file.name.split('.').pop().toLowerCase();
                
                if (fileExtension === 'csv') {
                    parseCSV(file);
                } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                    parseExcel(file);
                } else {
                    alert('Format file tidak didukung. Harap gunakan file CSV atau Excel.');
                }
            }
        }
        
        function parseCSV(file) {
            Papa.parse(file, {
                complete: function(results) {
                    importData(results.data);
                },
                header: true,
                skipEmptyLines: true
            });
        }
        
        function parseExcel(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                importData(jsonData);
            };
            reader.readAsArrayBuffer(file);
        }
        
        function importData(data) {
            if (data.length === 0) {
                alert('File tidak berisi data atau format tidak sesuai!');
                return;
            }
            
            const firstRow = data[0];
            const requiredFields = ['No', 'Customer ID', 'NIK', 'Nama', 'Alamat'];
            const missingFields = requiredFields.filter(field => !(field in firstRow));
            
            if (missingFields.length > 0) {
                alert(`File tidak memiliki kolom yang diperlukan: ${missingFields.join(', ')}`);
                return;
            }
            
            if (!confirm(`Anda akan mengimpor ${data.length} data nasabah. Lanjutkan?`)) {
                return;
            }
            
            const importedCustomers = data.map((row, index) => {
                return {
                    id: Date.now() + index,
                    no: row.No || 0,
                    customerId: row['Customer ID'] || '',
                    tglDrop: row['Tanggal Drop'] || new Date().toISOString().split('T')[0],
                    nik: row.NIK || '',
                    nama: row.Nama || '',
                    alamat: row.Alamat || '',
                    dokumen: row.Dokumen || '',
                    pinjamankin: row['Pinjaman (Rp)'] || '0',
                    pinjamanki: row.Pinjamanki || '',
                    fotoNasabah: row['Foto Nasabah (URL)'] || null, // Asumsi ada kolom ini di CSV/Excel jika mau impor URL
                    fotoRumah: row['Foto Rumah (URL)'] || null,
                    updatedAt: Date.now()
                };
            });
            
            customers = [...customers, ...importedCustomers];
            createCustomerCards(customers);
            renderTable();
            saveData();
            
            alert(`Berhasil mengimpor ${importedCustomers.length} data nasabah!`);
            showTab('view');
        }

        function exportToCSV() {
            if (customers.length === 0) {
                alert('Tidak ada data untuk diexport!');
                return;
            }
            
            const headers = ['No', 'Customer ID', 'Tanggal Drop', 'NIK', 'Nama', 'Alamat', 'Dokumen', 'Pinjaman (Rp)', 'Pinjamanki', 'Foto Nasabah (URL)', 'Foto Rumah (URL)'];
            const csvData = [headers];
            
            customers.forEach(customer => {
                csvData.push([
                    customer.no,
                    customer.customerId,
                    customer.tglDrop,
                    customer.nik,
                    customer.nama,
                    customer.alamat,
                    customer.dokumen,
                    customer.pinjamankin,
                    customer.pinjamanki,
                    customer.fotoNasabah || '',
                    customer.fotoRumah || ''
                ]);
            });
            
            const csvContent = csvData.map(row => row.map(field => `"${field}"`).join(',')).join('\n');
            const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nasabah_ksp_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        // --- END LOGIKA IMPORT ---

    </script>
</body>
</html>
